---
import { getCollection } from 'astro:content';
import BlogLayout from '../layouts/BlogLayout.astro';

const pageTitle = "Interactive Content Library";
const pageDesc = "A complete, filterable archive of all reviewed content.";

const slugify = (text: string) => {
  if (!text) return '';
  return text.toString().toLowerCase().replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
};

const allPosts = await getCollection('article');
const tableData = allPosts.map(post => ({
  title: post.data.title,
  category: post.data.category,
  tags: post.data.tags || [],
  reviewDate: post.data.reviewDate,
  postedDate: post.data.postedDate,
  source: post.data.source,
  channel: post.data.channel,
  postLink: `/article/${post.slug}/`,
  sourceLink: post.data.sourceLink
}));

const uniqueCategories = [...new Set(tableData.map(item => item.category).filter(Boolean))];
const uniqueTags = [...new Set(tableData.flatMap(item => item.tags).filter(Boolean))];
const uniqueSources = [...new Set(tableData.map(item => item.source).filter(Boolean))];
---
<BlogLayout title={pageTitle} description={pageDesc}>
  <header>
    <h1>Interactive Content Library</h1>
    <p>A complete archive of all reviewed content.</p>
  </header>
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search content...">
    <button class="reset-btn" id="reset-btn">Reset All</button>
  </div>
  <div class="filter-bar" id="filter-bar">
    <span>Filters</span>
    <button class="dropdown-btn" id="dropdown-btn">▼</button>
  </div>
  <div class="filters-container" id="filters-container">
    <div class="filter-group">
      <h4>Categories</h4>
      <div id="category-filters">
        {uniqueCategories.map(category => (
          <label><input type="checkbox" value={category} data-group="category" /> {category}</label>
        ))}
      </div>
    </div>
    <div class="filter-group">
      <h4>Tags</h4>
      <div id="tag-filters">
        {uniqueTags.map(tag => (
          <label><input type="checkbox" value={tag} data-group="tag" /> {tag}</label>
        ))}
      </div>
    </div>
    <div class="filter-group">
      <h4>Sources</h4>
      <div id="source-filters">
        {uniqueSources.map(source => (
          <label><input type="checkbox" value={source} data-group="source" /> {source}</label>
        ))}
      </div>
    </div>
  </div>
  <div class="table-wrapper">
    <table>
      <caption class="sr-only">{pageTitle}</caption>
      <thead>
        <tr>
          <th data-key="title" scope="col">Title</th>
          <th data-key="category" scope="col">Category</th>
          <th data-key="tags" scope="col">Tags</th>
          <th data-key="reviewDate" scope="col">Review Date</th>
          <th data-key="postedDate" scope="col">Posted Date</th>
          <th data-key="source" scope="col">Source</th>
          <th data-key="channel" scope="col">Channel/Publication</th>
          <th scope="col">Link</th>
        </tr>
      </thead>
      <tbody id="data-table-body">
      </tbody>
    </table>
  </div>
  <div class="pagination">
    <div class="page-controls" id="page-controls"></div>
    <div class="page-size">
      <label for="page-size">Show:</label>
      <select id="page-size">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
  </div>
</BlogLayout>
<style>
:root {
  --font: system-ui, sans-serif;
  --bg: #f9fafb;
  --text: #23272f;
  --header: #f3f4f6;
  --border: #e5e7eb;
  --accent: #6366f1;
  --hover: #e0e7ff;
}

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
}

header h1 {
  font-size: 2rem;
  margin-bottom: 0.2em;
}

header p { color: #697181; }

.search-bar {
  display: flex; gap: 1em; align-items: center; margin-bottom: 1em;
}

.search-bar input {
  border: 1px solid var(--border); border-radius: 6px;
  padding: 0.7em 1em; font-size: 1em; min-width: 240px; background: #fff;
}

.reset-btn {
  border: 1px solid var(--border);
  border-radius: 6px;
  background-color: var(--header);
  padding: 0.6em 1.2em;
  cursor: pointer;
  font-size: 1em;
}

.filter-bar {
  display: flex; align-items: center; gap: 1em; 
  background: var(--header); border: 1px solid var(--border);
  border-radius: 8px; margin-bottom: 1em; padding: 0.85em 1.2em;
}

.dropdown-btn {
  padding: 0 0.3em;
  background: none;
  border: none;
  color: var(--accent);
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
}

.filters-container {
  display: none;
  gap: 1.8em; padding: 1em 1.2em 1.5em 1.2em; margin-bottom: 2em;
  background-color: var(--header);
  border: 1px solid var(--border);
  border-radius: 8px;
}

.filter-group { display: flex; flex-direction: column; gap: 0.36em; }
.filter-group h4 { margin-bottom: 0.3em; font-weight: 600; }
.filter-group label { cursor: pointer; }

/* Table styles */
.table-wrapper { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  border-radius: 7px 7px 0 0;
  font-size: 1em;
}
caption.sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0 0 0 0); }
th, td {
  text-align: left;
  padding: 0.85em 1em;
  border-bottom: 1px solid var(--border);
}
th {
  font-weight: 650;
  background: var(--header);
}
tbody tr:nth-child(even) {
  background: #f5f6fa;
}
tbody tr:hover {
  background: var(--hover);
}

td a[href*='/tag/'] {
  display: inline-block;
  background: #eef2ff;
  color: #23298f;
  border-radius: 1em;
  padding: 0.2em 0.8em;
  margin-right: 0.2em;
  font-size: 0.97em;
  font-weight: 600;
  text-decoration: none;
}

a {
  color: var(--accent);
  text-decoration: underline;
  font-weight: 500;
}

.sort-asc::after { content: " ▲"; font-size: 0.8em; }
.sort-desc::after { content: " ▼"; font-size: 0.8em; }

/* Pagination */
.pagination {
  display: flex; gap: 2em; align-items: center;
  margin-top: 1.8em;
}
.page-controls { display: flex; gap: 0.3em; }
.page-controls button {
  padding: 0.4em 0.9em;
  border: 1px solid var(--border);
  border-radius: 7px;
  cursor: pointer;
  background: var(--header);
}
.page-controls button.active { background: var(--accent); color: white; }
.page-size { display: flex; align-items: center; gap: 0.5em; }

@media (max-width: 700px) {
  th, td { padding: 0.56em 0.7em; font-size: 0.99em; }
}
</style>
<script define:vars={{ tableData }}>
  document.addEventListener('DOMContentLoaded', () => {
    const slugify = text => !text ? '' : text.toString().toLowerCase()
      .replace(/\s+/g, '-').replace(/[^\w\-]+/g, '')
      .replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
    const tableBody = document.getElementById('data-table-body');
    const filtersContainer = document.getElementById('filters-container');
    const dropdownBtn = document.getElementById('dropdown-btn');
    const filterBar = document.getElementById('filter-bar');
    const searchInput = document.getElementById('search-input');
    const resetBtn = document.getElementById('reset-btn');
    const pageControls = document.getElementById('page-controls');
    const pageSizeSelect = document.getElementById('page-size');
    let currentSort = { key: null, order: 'asc' };
    let currentPage = 1;
    let pageSize = parseInt(pageSizeSelect.value);

    function renderTable(data) {
      tableBody.innerHTML = '';
      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No results found</td></tr>`;
        renderPagination(0);
        return;
      }
      const startIndex = (currentPage - 1) * pageSize;
      const pageData = data.slice(startIndex, startIndex + pageSize);
      pageData.forEach(item => {
        const tr = document.createElement('tr');
        const tagsHtml = (item.tags || []).map(tag =>
          `<a href="/tag/${slugify(tag)}/">${tag}</a>`
        ).join('');
        tr.innerHTML = `
          <td><a href="${item.postLink}">${item.title}</a></td>
          <td><a href="/category/${slugify(item.category)}/">${item.category}</a></td>
          <td>${tagsHtml}</td>
          <td>${item.reviewDate || ''}</td>
          <td>${item.postedDate || ''}</td>
          <td>${item.source || ''}</td>
          <td>${item.channel || ''}</td>
          <td>
            <a href="${item.postLink}" target="_blank">Post</a>
            ${item.sourceLink ? '| <a href="'+item.sourceLink+'" target="_blank">Source</a>' : ""}
          </td>
        `;
        tableBody.appendChild(tr);
      });
      renderPagination(data.length);
    }
    function renderPagination(totalItems) {
      pageControls.innerHTML = '';
      const totalPages = Math.ceil(totalItems / pageSize);
      if (totalPages <= 1) return;
      const prevBtn = document.createElement('button');
      prevBtn.textContent = "Prev";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => { currentPage--; applyAll(); };
      pageControls.appendChild(prevBtn);
      for(let i=1; i<= totalPages; i++){
        const btn = document.createElement('button');
        btn.textContent = i;
        if(i === currentPage) btn.classList.add('active');
        btn.onclick = () => { currentPage = i; applyAll(); };
        pageControls.appendChild(btn);
      }
      const nextBtn = document.createElement('button');
      nextBtn.textContent = "Next";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => { currentPage++; applyAll(); };
      pageControls.appendChild(nextBtn);
    }
    function getActiveFilters() {
      const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
      return {
        categories: checked.filter(c => c.dataset.group === "category").map(c => c.value),
        tags: checked.filter(c => c.dataset.group === "tag").map(c => c.value),
        sources: checked.filter(c => c.dataset.group === "source").map(c => c.value)
      };
    }
    function applyAll() {
      const { categories, tags, sources } = getActiveFilters();
      const query = searchInput.value.toLowerCase();
      let filtered = tableData.filter(item => {
        const matchCategory = categories.length ? categories.includes(item.category) : true;
        const matchTags = tags.length ? tags.some(tag => item.tags && item.tags.includes(tag)) : true;
        const matchSource = sources.length ? sources.includes(item.source) : true;
        const combinedText = `${item.title} ${item.category} ${item.tags ? item.tags.join(" ") : ''} ${item.source} ${item.channel}`.toLowerCase();
        const matchSearch = combinedText.includes(query);
        return matchCategory && matchTags && matchSource && matchSearch;
      });
      if (currentSort.key) {
        filtered.sort((a, b) => {
          let valA = a[currentSort.key]; let valB = b[currentSort.key];
          if (currentSort.key.toLowerCase().includes("date")) { valA = new Date(valA); valB = new Date(valB); }
          if (Array.isArray(valA)) valA = valA.join(", "); if (Array.isArray(valB)) valB = valB.join(", ");
          if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
          if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
          return 0;
        });
      }
      const totalPages = Math.ceil(filtered.length / pageSize);
      if(currentPage > totalPages) currentPage = totalPages || 1;
      renderTable(filtered);
    }
    function resetAll() {
      searchInput.value = "";
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      currentSort = { key: null, order: 'asc' };
      document.querySelectorAll("thead th").forEach(t => t.classList.remove("sort-asc", "sort-desc"));
      currentPage = 1;
      applyAll();
    }
    filterBar.addEventListener('click', () => {
      const isVisible = filtersContainer.style.display === 'flex';
      filtersContainer.style.display = isVisible ? 'none' : 'flex';
      dropdownBtn.textContent = isVisible ? '▼' : '▲';
    });
    filtersContainer.addEventListener("change", () => { currentPage = 1; applyAll(); });
    searchInput.addEventListener("input", () => { currentPage = 1; applyAll(); });
    resetBtn.addEventListener("click", resetAll);
    pageSizeSelect.addEventListener("change", () => { pageSize = parseInt(pageSizeSelect.value); currentPage = 1; applyAll(); });
    document.querySelectorAll("thead th[data-key]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.dataset.key;
        if (currentSort.key === key) { currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';}
        else { currentSort.key = key; currentSort.order = 'asc'; }
        document.querySelectorAll("thead th").forEach(t => t.classList.remove("sort-asc", "sort-desc"));
        th.classList.add(currentSort.order === 'asc' ? "sort-asc" : "sort-desc");
        applyAll();
      });
    });
    applyAll();
  });
</script>
